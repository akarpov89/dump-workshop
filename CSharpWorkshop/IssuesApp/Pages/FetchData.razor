@page "/fetchdata"
@inject IIssueService IssueService

@using System.Threading
@using IssuesApp.Data

<button class="btn btn-primary" @onclick="StartLoading">Load issues</button>
<button class="btn btn-primary" @onclick="CancelLoading">Cancel</button>

@if (issues == null)
{
    <p>Issues count: @issuesCount</p>
}
else
{
    <p>Issues count: @issuesCount</p>

    <table class="table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Category</th>
                <th>Author</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var issue in issues)
            {
                <tr>
                    <td style="max-width: 500px"><a href="@issue.Url" target="_blank">@issue.Title</a></td>
                    <td>@issue.Categorize()</td>
                    <td><a href="@issue.Author?.Url" target="_blank">@issue.Author?.Login</a></td>
                    <td>@(issue.State.ToString())</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    IEnumerable<Issue>? issues;
    int issuesCount;

    CancellationTokenSource? cts;

    private async void StartLoading()
    {
        issues = null;
        issuesCount = 0;

        var progress = new ActionProgress(value =>
        {
            InvokeAsync(() =>
            {
                issuesCount = value;
                StateHasChanged();
            });
        });

        cts = new CancellationTokenSource();

        try
        {
            issues = await IssueService.GetIssuesAsync(progress, cts.Token);
            StateHasChanged();
        }
        catch (OperationCanceledException)
        {
        }
    }

    private void CancelLoading()
    {
        cts?.Cancel();
    }

    private class ActionProgress : IProgress<int>
    {
        private readonly Action<int> myOnProgress;

        public ActionProgress(Action<int> onProgress)
        {
            myOnProgress = onProgress;
        }

        public void Report(int value)
        {
            myOnProgress(value);
        }
    }
}
